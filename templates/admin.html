{% extends "base.html" %}
{% block title %}Administración{% endblock %}
{% block content %}

<h2 style="margin:10px 0 14px 0;">Administración</h2>

<form class="card form" method="post" style="padding:16px;">
  <div class="grid two">
    <label class="field">
      <span>Nombre completo</span>
      <input name="nombre" placeholder="Ej. Ana Pérez" required />
    </label>

    <label class="field">
      <span>Etapa</span>
      <select name="etapa" id="etapa_new" required>
        <option value="">Selecciona etapa</option>
        {% for e in ETAPAS.keys() %}
          <option value="{{ e }}">{{ e }}</option>
        {% endfor %}
      </select>
    </label>

    <label class="field">
      <span>Nivel</span>
      <select name="nivel" id="nivel_new" required>
        <option value="">Selecciona nivel</option>
      </select>
    </label>

    <label class="field">
      <span>Nota</span>
      <input name="nota" type="number" step="0.01" min="0" max="100" placeholder="0–100" required />
    </label>
  </div>
  <div class="help">
    El estado se calcula automáticamente (Aprobado si nota ≥ {{ PASSING_GRADE }}).
  </div>

  <!-- NUEVO: Campo para link de Drive (notas) -->
  <div class="field">
    <span>Notas (link de Drive) <small style="color:#6b7280;font-weight:400">(opcional)</small></span>
    <input class="input" type="url" name="notas" placeholder="https://drive.google.com/..." />
  </div>

  <div class="btns">
    <button class="btn btn-primary">Guardar y generar QR</button>
    <a href="{{ url_for('export_csv') }}" class="btn">Exportar CSV</a>
    <a href="{{ url_for('export_xlsx') }}" class="btn">Exportar Excel (.xlsx)</a>
  </div>
</form>

<form class="card" method="post" action="{{ url_for('import_xlsx') }}" enctype="multipart/form-data" style="padding:12px;margin:12px 0;">
  <div class="grid two">
    <div>
      <label class="field">
        <span>Importar estudiantes (.xlsx)</span>
        <input type="file" name="archivo" accept=".xlsx" required>
      </label>
      <small class="help">
        El archivo debe tener columnas: <code>nombre</code>, <code>etapa</code>, <code>nivel</code>, <code>nota</code>, <code>notas</code> (link de Drive).
      </small>
    </div>
    <div style="align-self:end;">
      <button class="btn btn-primary">Importar XLSX</button>
      <a class="btn" href="{{ url_for('download_import_template') }}">Descargar plantilla</a>
    </div>
  </div>
</form>

<form method="get" action="{{ url_for('admin') }}" class="card" style="padding:12px;margin:12px 0;">
  <div class="toolbar">
    <input class="input" name="q" value="{{ q or '' }}" placeholder="Buscar por nombre, etapa/nivel o token…" />
    <select class="input" name="per_page" onchange="this.form.submit()">
      <option value="10"  {{ 'selected' if per_page==10 else '' }}>10</option>
      <option value="25"  {{ 'selected' if per_page==25 else '' }}>25</option>
      <option value="50"  {{ 'selected' if per_page==50 else '' }}>50</option>
      <option value="100" {{ 'selected' if per_page==100 else '' }}>100</option>
    </select>
    <input type="hidden" name="sort" value="{{ sort }}">
    <input type="hidden" name="order" value="{{ order }}">
    <button class="btn btn-primary">Filtrar</button>
  </div>
</form>

<div class="table-wrap">
  <table class="responsive">
    <thead>
      {% set inv = 'asc' if order == 'desc' else 'desc' %}
      <tr>
        <th>#</th>
        <th><a href="{{ url_for('admin', q=q, sort='nombre', order=inv if sort=='nombre' else 'asc', per_page=per_page, page=1) }}">Nombre {% if sort=='nombre' %}{{ '▲' if order=='asc' else '▼' }}{% endif %}</a></th>
        <th><a href="{{ url_for('admin', q=q, sort='curso', order=inv if sort=='curso' else 'asc', per_page=per_page, page=1) }}">Etapa / Nivel {% if sort=='curso' %}{{ '▲' if order=='asc' else '▼' }}{% endif %}</a></th>
        <th><a href="{{ url_for('admin', q=q, sort='nota', order=inv if sort=='nota' else 'asc', per_page=per_page, page=1) }}">Nota {% if sort=='nota' %}{{ '▲' if order=='asc' else '▼' }}{% endif %}</a></th>
        <th><a href="{{ url_for('admin', q=q, sort='estado', order=inv if sort=='estado' else 'asc', per_page=per_page, page=1) }}">Estado {% if sort=='estado' %}{{ '▲' if order=='asc' else '▼' }}{% endif %}</a></th>
        <th><a href="{{ url_for('admin', q=q, sort='creado_en', order=inv if sort=='creado_en' else 'desc', per_page=per_page, page=1) }}">Creado {% if sort=='creado_en' %}{{ '▲' if order=='asc' else '▼' }}{% endif %}</a></th>
        <th>Certificado</th>
        <th>QR</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for e in estudiantes %}
      <tr>
        <td class="text-muted">{{ (page - 1) * per_page + loop.index }}</td>
        <td data-th="Nombre">{{ e.nombre }}</td>
        <td data-th="Etapa / Nivel">{{ e.curso }}</td>
        <td data-th="Nota">{{ '%.2f'|format(e.nota) }}</td>
        <td data-th="Estado" class="{{ 'ok' if e.estado=='Aprobado' else 'bad' }}">{{ e.estado }}</td>

        <!-- MODIFICADO: Celda “Creado” editable en línea -->
        <td data-th="Creado">
          <form method="post"
                action="{{ url_for('update_fecha', id=e.id) }}"
                class="inline-date-form">
            <input type="datetime-local"
                   name="creado_en"
                   value="{{ e.creado_en|dtlocal }}"
                   class="input"
                   style="padding:6px 8px;font-size:12px;height:32px;max-width:210px;">
            <button class="btn btn-sm">Guardar</button>
          </form>
        </td>

        <td data-th="Certificado"><a class="btn btn-outline" href="{{ e.cert_url }}" target="_blank">Ver</a></td>
        <td data-th="QR"><img src="{{ e.qr_url }}" alt="QR" class="qr-thumb" /></td>
        <td data-th="Acciones">
          <div class="row-actions">
            <a class="btn btn-sm btn-primary" href="{{ url_for('editar_estudiante', id=e.id) }}">✏️ Editar</a>
            <form method="post" action="{{ url_for('regenerar_qr', token=e.token) }}">
              <button class="btn btn-sm btn-secondary">🔄 Re-gen</button>
            </form>
            <form method="post" action="{{ url_for('eliminar_estudiante', id=e.id) }}" class="delete-form">
              <button type="button" class="btn danger delete-btn">Eliminar</button>
            </form>
          </div>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="9" style="text-align:center;">Sin registros</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav>
  <ul class="pagination">
    <li class="page-item {{ 'disabled' if page<=1 }}">
      <a class="page-link" href="{{ url_for('admin', q=q, sort=sort, order=order, page=page-1, per_page=per_page) }}">Anterior</a>
    </li>
    {% for p in pages %}
    <li class="page-item {{ 'active' if p==page }}">
      <a class="page-link" href="{{ url_for('admin', q=q, sort=sort, order=order, page=p, per_page=per_page) }}">{{ p }}</a>
    </li>
    {% endfor %}
    <li class="page-item {{ 'disabled' if page>=total_pages }}">
      <a class="page-link" href="{{ url_for('admin', q=q, sort=sort, order=order, page=page+1, per_page=per_page) }}">Siguiente</a>
    </li>
  </ul>
</nav>

<!-- JSON seguro + JS puro -->
<script id="mapa-data" type="application/json">{{ ETAPAS|tojson }}</script>
<script>
  const MAPA = JSON.parse(document.getElementById('mapa-data').textContent);
  const etapaSel = document.getElementById('etapa_new');
  const nivelSel = document.getElementById('nivel_new');

  function fillNiveles(etapa, selectEl){
    selectEl.innerHTML = '<option value="">Selecciona nivel</option>';
    (MAPA[etapa] || []).forEach(n=>{
      const o = document.createElement('option');
      o.value = n; o.textContent = n;
      selectEl.appendChild(o);
    });
  }

  etapaSel.addEventListener('change', ()=> fillNiveles(etapaSel.value, nivelSel));
</script>

{% endblock %}
